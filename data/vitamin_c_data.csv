import pandas as pd
import io

# 1. CSV strings for the core tables
csv_4_1 = """Sample ID,Crop Type,Variety / Source,Collection Location,Collection Date,Analysis Date,Vitamin C (mg/100g) Mean ± SD,Moisture Content (%w.b),Water Activity (a),pH,Titratable Acidity (%),Total Soluble (°Brix),Total Solids (%)
BZ-ORG,Orange (Citrus sinensis),Local Sweet Orange,Yan Kaba Market,01/09/2025,01/09/2025,52.3 ± 1.6,86.4 ± 1.2,0.984 ± 0.003,3.4 ± 0.2,0.82 ± 0.05,11.2 ± 0.3,13.6 ± 1.2
BZ-BAO,Baobab (Adansonia digitata),Cultivated,Yan Kaba Market,01/09/2025,01/09/2025,225.8 ± 8.8,13.8 ± 0.8,0.682 ± 0.005,3.1 ± 0.1,2.35 ± 0.08,18.4 ± 0.5,86.2 ± 0.8
BZ-FPK,Fluted Pumpkin (Telfairia occidentalis),Green Variety,Yan Kaba Market,01/09/2025,01/09/2025,85.2 ± 2.5,89.1 ± 1.4,0.991 ± 0.002,6.8 ± 0.3,0.12 ± 0.01,3.2 ± 0.2,10.9 ± 1.4
BZ-SPN,Spinach (Amaranthus hybridus),Local Variety and Cultivated,Dala Orthopaedic Local Farm,01/09/2025,01/09/2025,62.4 ± 2.3,91.7 ± 1.6,0.993 ± 0.002,6.5 ± 0.2,0.08 ± 0.01,2.1 ± 0.1,8.3 ± 1.6
"""

csv_4_2 = """Crop,Temp (°C),0 min,10 min,20 min,30 min,40 min,60 min
Orange (Citrus sinensis),60,52.3±1.6,47.2±1.3,42.1±1.1,37.4±1.0,33.1±0.9,26.2±0.7
Orange (Citrus sinensis),70,52.3±1.6,45.6±1.2,39.2±1.0,33.8±0.9,29.2±0.8,22.4±0.6
Orange (Citrus sinensis),80,52.3±1.6,43.8±1.2,35.8±1.0,29.2±0.8,23.9±0.7,17.1±0.5
Orange (Citrus sinensis),90,52.3±1.6,41.5±1.1,32.1±0.9,25.3±0.7,20.1±0.6,13.8±0.4
Orange (Citrus sinensis),100,52.3±1.6,39.1±1.1,28.4±0.8,20.7±0.6,15.8±0.5,10.3±0.3
Baobab pulp (Adansonia digitata),60,225.8±8.8,215.4±8.3,205.3±7.9,195.8±7.6,186.9±7.3,171.8±6.7
Baobab pulp (Adansonia digitata),70,225.8±8.8,211.8±8.2,198.4±7.7,186.2±7.2,175.1±6.8,156.9±6.1
Baobab pulp (Adansonia digitata),80,225.8±8.8,207.9±8.0,191.2±7.4,176.1±6.8,162.8±6.3,141.5±5.5
Baobab pulp (Adansonia digitata),90,225.8±8.8,203.2±7.9,182.8±7.1,165.4±6.4,150.3±5.8,127.6±5.0
Baobab pulp (Adansonia digitata),100,225.8±8.8,198.3±7.7,174.2±6.8,153.8±6.0,137.2±5.3,114.9±4.5
Fluted pumpkin (Telfairia occidentalis),60,85.2±2.5,78.3±2.2,71.8±2.0,66.0±1.8,60.9±1.7,53.2±1.5
Fluted pumpkin (Telfairia occidentalis),70,85.2±2.5,76.1±2.1,67.8±1.9,60.8±1.7,54.9±1.5,46.3±1.3
Fluted pumpkin (Telfairia occidentalis),80,85.2±2.5,73.1±2.0,62.4±1.7,53.8±1.5,47.1±1.3,38.4±1.1
Fluted pumpkin (Telfairia occidentalis),90,85.2±2.5,69.8±1.9,56.9±1.6,47.2±1.3,40.3±1.1,31.8±0.9
Fluted pumpkin (Telfairia occidentalis),100,85.2±2.5,66.8±1.8,52.1±1.4,41.8±1.2,34.5±1.0,25.9±0.7
Spinach (Amaranthus hybridus),60,62.4±2.3,56.4±2.0,50.8±1.8,45.9±1.6,41.7±1.5,35.4±1.3
Spinach (Amaranthus hybridus),70,62.4±2.3,54.8±1.9,47.9±1.7,42.3±1.5,37.8±1.3,30.9±1.1
Spinach (Amaranthus hybridus),80,62.4±2.3,51.5±1.8,42.6±1.5,35.8±1.3,30.7±1.1,23.8±0.9
Spinach (Amaranthus hybridus),90,62.4±2.3,48.7±1.7,37.9±1.3,30.6±1.1,25.4±0.9,18.9±0.7
Spinach (Amaranthus hybridus),100,62.4±2.3,45.7±1.6,33.4±1.2,25.2±0.9,19.8±0.7,13.9±0.5
"""

csv_4_3 = """Crop,Temp (°C),0 min,10 min,20 min,30 min,40 min,60 min
Orange (Citrus sinensis),60,86.4±1.2,83.5±1.1,80.7±1.0,78.1±0.9,75.6±0.9,71.2±0.8
Orange (Citrus sinensis),70,86.4±1.2,82.1±1.0,78.0±0.9,74.3±0.8,70.9±0.8,65.3±0.7
Orange (Citrus sinensis),80,86.4±1.2,80.9±1.0,75.8±0.9,71.3±0.8,67.4±0.7,61.2±0.6
Orange (Citrus sinensis),90,86.4±1.2,79.2±0.9,72.9±0.8,67.6±0.7,63.1±0.6,56.4±0.5
Orange (Citrus sinensis),100,86.4±1.2,77.8±0.9,70.2±0.8,64.1±0.7,59.3±0.6,52.1±0.5
Baobab pulp (Adansonia digitata),60,13.8±0.8,12.9±0.7,12.1±0.6,11.4±0.6,10.8±0.5,9.8±0.5
Baobab pulp (Adansonia digitata),70,13.8±0.8,12.6±0.7,11.5±0.6,10.6±0.5,9.8±0.5,8.6±0.4
Baobab pulp (Adansonia digitata),80,13.8±0.8,12.3±0.6,11.0±0.5,9.9±0.5,9.0±0.4,7.6±0.3
Baobab pulp (Adansonia digitata),90,13.8±0.8,11.9±0.6,10.3±0.5,9.1±0.4,8.2±0.4,6.8±0.3
Baobab pulp (Adansonia digitata),100,13.8±0.8,11.7±0.6,9.9±0.5,8.6±0.4,7.6±0.3,6.2±0.3
Fluted pumpkin (Telfairia occidentalis),60,89.1±1.4,85.9±1.3,82.9±1.2,80.1±1.1,77.5±1.0,73.1±0.9
Fluted pumpkin (Telfairia occidentalis),70,89.1±1.4,84.6±1.2,80.4±1.1,76.5±1.0,73.0±0.9,67.2±0.8
Fluted pumpkin (Telfairia occidentalis),80,89.1±1.4,83.2±1.2,77.9±1.1,73.4±1.0,69.6±0.9,63.4±0.8
Fluted pumpkin (Telfairia occidentalis),90,89.1±1.4,81.5±1.1,74.6±1.0,69.2±0.9,64.8±0.8,57.9±0.7
Fluted pumpkin (Telfairia occidentalis),100,89.1±1.4,79.8±1.1,71.8±1.0,65.4±0.9,60.3±0.8,52.8±0.7
Spinach (Amaranthus hybridus),60,91.7±1.6,89.2±1.5,86.8±1.4,84.5±1.3,82.3±1.2,78.3±1.1
Spinach (Amaranthus hybridus),70,91.7±1.6,88.1±1.4,84.7±1.3,81.6±1.2,78.7±1.1,73.5±1.0
Spinach (Amaranthus hybridus),80,91.7±1.6,87.2±1.4,83.1±1.3,79.5±1.2,76.4±1.1,71.0±1.0
Spinach (Amaranthus hybridus),90,91.7±1.6,85.9±1.3,80.7±1.2,76.4±1.1,72.7±1.0,66.5±0.9
Spinach (Amaranthus hybridus),100,91.7±1.6,84.6±1.3,78.4±1.2,73.4±1.1,69.4±1.0,63.2±0.9
"""

csv_4_5 = """Crop,Temp (°C),0 min,10 min,20 min,30 min,40 min,60 min
Orange (Citrus sinensis),60,100.0,90.2,80.5,71.5,63.3,50.1
Orange (Citrus sinensis),70,100.0,87.2,74.9,64.6,55.8,42.8
Orange (Citrus sinensis),80,100.0,83.7,68.5,55.8,45.7,32.7
Orange (Citrus sinensis),90,100.0,79.3,61.4,48.4,38.4,26.4
Orange (Citrus sinensis),100,100.0,74.8,54.3,39.6,30.2,19.7
Baobab pulp (Adansonia digitata),60,100.0,95.4,90.9,86.7,82.8,76.1
Baobab pulp (Adansonia digitata),70,100.0,93.8,87.9,82.5,77.5,69.5
Baobab pulp (Adansonia digitata),80,100.0,92.1,84.7,78.0,72.1,62.7
Baobab pulp (Adansonia digitata),90,100.0,90.0,81.0,73.3,66.6,56.5
Baobab pulp (Adansonia digitata),100,100.0,87.8,77.2,68.1,60.8,50.9
Fluted pumpkin (Telfairia occidentalis),60,100.0,91.9,84.3,77.5,71.5,62.4
Fluted pumpkin (Telfairia occidentalis),70,100.0,89.3,79.6,71.4,64.4,54.3
Fluted pumpkin (Telfairia occidentalis),80,100.0,85.8,73.2,63.1,55.3,45.1
Fluted pumpkin (Telfairia occidentalis),90,100.0,81.9,66.8,55.4,47.3,37.3
Fluted pumpkin (Telfairia occidentalis),100,100.0,78.4,61.2,49.1,40.5,30.4
Spinach (Amaranthus hybridus),60,100.0,90.4,81.4,73.6,66.8,56.7
Spinach (Amaranthus hybridus),70,100.0,87.8,76.8,67.8,60.6,49.5
Spinach (Amaranthus hybridus),80,100.0,82.5,68.3,57.4,49.2,38.1
Spinach (Amaranthus hybridus),90,100.0,78.0,60.7,49.0,40.7,30.3
Spinach (Amaranthus hybridus),100,100.0,73.2,53.5,40.4,31.7,22.3
"""

csv_4_6 = """Crop,Temp (°C),0 min,10 min,20 min,30 min,40 min,60 min
Orange (Citrus sinensis),60,0.0,9.8,19.5,28.5,36.7,49.9
Orange (Citrus sinensis),70,0.0,12.8,25.1,35.4,44.2,57.2
Orange (Citrus sinensis),80,0.0,16.3,31.5,44.2,54.3,67.3
Orange (Citrus sinensis),90,0.0,20.7,38.6,51.6,61.6,73.6
Orange (Citrus sinensis),100,0.0,25.2,45.7,60.4,69.8,80.3
Baobab pulp (Adansonia digitata),60,0.0,4.6,9.1,13.3,17.2,23.9
Baobab pulp (Adansonia digitata),70,0.0,6.2,12.1,17.5,22.5,30.5
Baobab pulp (Adansonia digitata),80,0.0,7.9,15.3,22.0,27.9,37.3
Baobab pulp (Adansonia digitata),90,0.0,10.0,19.0,26.7,33.4,43.5
Baobab pulp (Adansonia digitata),100,0.0,12.2,22.8,31.9,39.2,49.1
Fluted pumpkin (Telfairia occidentalis),60,0.0,8.1,15.7,22.5,28.5,37.6
Fluted pumpkin (Telfairia occidentalis),70,0.0,10.7,20.4,28.6,35.6,45.7
Fluted pumpkin (Telfairia occidentalis),80,0.0,14.2,26.8,36.9,44.7,54.9
Fluted pumpkin (Telfairia occidentalis),90,0.0,18.1,33.2,44.6,52.7,62.7
Fluted pumpkin (Telfairia occidentalis),100,0.0,21.6,38.8,50.9,59.5,69.6
Spinach (Amaranthus hybridus),60,0.0,9.6,18.6,26.4,33.2,43.3
Spinach (Amaranthus hybridus),70,0.0,12.2,23.2,32.2,39.4,50.5
Spinach (Amaranthus hybridus),80,0.0,17.5,31.7,42.6,50.8,61.9
Spinach (Amaranthus hybridus),90,0.0,22.0,39.3,51.0,59.3,69.7
Spinach (Amaranthus hybridus),100,0.0,26.8,46.5,59.6,68.3,77.7
"""

csv_4_15 = """Sample,Temperature (°C),k (min ⁻ ¹),R²,Temperature (K),1/T (K ⁻ ¹)
Orange (Citrus sinensis),60,0.0098 ± 0.0004,0.994,333,0.003003
Orange (Citrus sinensis),70,0.0139 ± 0.0005,0.993,343,0.002915
Orange (Citrus sinensis),80,0.0181 ± 0.0006,0.992,353,0.002833
Orange (Citrus sinensis),90,0.0247 ± 0.0007,0.990,363,0.002755
Orange (Citrus sinensis),100,0.0324 ± 0.0009,0.988,373,0.002681
Baobab pulp (Adansonia digitata),60,0.0048 ± 0.0002,0.989,333,0.003003
Baobab pulp (Adansonia digitata),70,0.0072 ± 0.0003,0.990,343,0.002915
Baobab pulp (Adansonia digitata),80,0.0106 ± 0.0004,0.990,353,0.002833
Baobab pulp (Adansonia digitata),90,0.0151 ± 0.0005,0.989,363,0.002755
Baobab pulp (Adansonia digitata),100,0.0189 ± 0.0005,0.991,373,0.002681
Fluted pumpkin (Telfairia occidentalis),60,0.0073 ± 0.0003,0.993,333,0.003003
Fluted pumpkin (Telfairia occidentalis),70,0.0112 ± 0.0004,0.992,343,0.002915
Fluted pumpkin (Telfairia occidentalis),80,0.0152 ± 0.0005,0.989,353,0.002833
Fluted pumpkin (Telfairia occidentalis),90,0.0209 ± 0.0006,0.990,363,0.002755
Fluted pumpkin (Telfairia occidentalis),100,0.0271 ± 0.0007,0.990,373,0.002681
Spinach (Amaranthus hybridus),60,0.0089 ± 0.0003,0.992,333,0.003003
Spinach (Amaranthus hybridus),70,0.0145 ± 0.0005,0.991,343,0.002915
Spinach (Amaranthus hybridus),80,0.0196 ± 0.0006,0.991,353,0.002833
Spinach (Amaranthus hybridus),90,0.0263 ± 0.0007,0.989,363,0.002755
Spinach (Amaranthus hybridus),100,0.0348 ± 0.0009,0.989,373,0.002681
"""

csv_4_17 = """Sample,60°C,70°C,80°C,90°C
Orange,70.7 min,49.9 min,38.3 min,28.1 min
Baobab,144.4 min,96.3 min,65.4 min,45.9 min
Pumpkin,95.0 min,61.9 min,45.6 min,33.2 min
Spinach,77.9 min,47.8 min,35.4 min,26.4 min
"""

# 2. Define a function to load and melt time-series data
def load_and_melt(csv_data, value_name):
    df = pd.read_csv(io.StringIO(csv_data))
    df_melt = df.melt(
        id_vars=['Crop', 'Temp (°C)'],
        var_name='Time (min)',
        value_name=value_name
    )
    # Clean 'Time (min)' column: '0 min' -> 0, '10 min' -> 10, etc.
    df_melt['Time (min)'] = df_melt['Time (min)'].str.replace(' min', '', regex=False).astype(int)
    return df_melt

# 3. Process time-series data (4.2, 4.3, 4.5, 4.6)
df_vc = load_and_melt(csv_4_2, 'Vitamin C (mg/100g) ± SD')
df_moisture = load_and_melt(csv_4_3, 'Moisture Content (%) ± SD')
df_retention = load_and_melt(csv_4_5, 'Vitamin C Retention (%)')
df_loss = load_and_melt(csv_4_6, 'Vitamin C Loss (%)')

# 4. Merge the time-series data
time_series_data = df_vc.merge(df_moisture, on=['Crop', 'Temp (°C)', 'Time (min)'], how='outer')
time_series_data = time_series_data.merge(df_retention, on=['Crop', 'Temp (°C)', 'Time (min)'], how='outer')
time_series_data = time_series_data.merge(df_loss, on=['Crop', 'Temp (°C)', 'Time (min)'], how='outer')

# 5. Process Initial Properties (Table 4.1)
df_4_1 = pd.read_csv(io.StringIO(csv_4_1))
df_4_1 = df_4_1.rename(columns={'Crop Type': 'Crop'})

# Select and rename initial features for clarity
initial_features = df_4_1[['Crop', 'Variety / Source', 'Vitamin C (mg/100g) Mean ± SD', 'Moisture Content (%w.b)', 'Water Activity (a)', 'pH', 'Titratable Acidity (%)', 'Total Soluble (°Brix)', 'Total Solids (%)']]
initial_features = initial_features.rename(columns={'Vitamin C (mg/100g) Mean ± SD': 'Initial Vitamin C (mg/100g) ± SD',
                                                    'Moisture Content (%w.b)': 'Initial Moisture Content (%w.b)'})

# 6. Process Kinetic Summary (Table 4.15 & 4.17)
df_4_15 = pd.read_csv(io.StringIO(csv_4_15))
df_4_15 = df_4_15.rename(columns={'Sample': 'Crop', 'Temperature (°C)': 'Temp (°C)'})
kinetic_summary_15 = df_4_15[['Crop', 'Temp (°C)', 'k (min ⁻ ¹)', 'R²', 'Temperature (K)', '1/T (K ⁻ ¹)']]

df_4_17 = pd.read_csv(io.StringIO(csv_4_17))
# Melt half-life data
df_4_17_melt = df_4_17.melt(
    id_vars=['Sample'],
    var_name='Temp (°C)',
    value_name='Half-Life (min)'
)
df_4_17_melt = df_4_17_melt.rename(columns={'Sample': 'Crop'})
df_4_17_melt['Temp (°C)'] = df_4_17_melt['Temp (°C)'].str.replace('°C', '', regex=False).astype(int)

# Map the short crop names in 4.17 to the full names for merging
name_map = {
    'Orange': 'Orange (Citrus sinensis)',
    'Baobab': 'Baobab pulp (Adansonia digitata)',
    'Pumpkin': 'Fluted pumpkin (Telfairia occidentalis)',
    'Spinach': 'Spinach (Amaranthus hybridus)'
}
df_4_17_melt['Crop'] = df_4_17_melt['Crop'].replace(name_map)
df_4_17_melt = df_4_17_melt.rename(columns={'Temp (°C)': 'Temp (°C)'})

# Merge kinetic summaries
kinetic_summary = kinetic_summary_15.merge(df_4_17_melt, on=['Crop', 'Temp (°C)'], how='outer')


# 7. Final Merges
# Merge time-series data with kinetic summary (on Crop and Temp)
final_data = time_series_data.merge(kinetic_summary, on=['Crop', 'Temp (°C)'], how='left')

# The 'Crop' names in initial_features need to match the 'Crop' names in the main merged table.
initial_features['Crop'] = initial_features['Crop'].replace({
    'Orange (Citrus sinensis)': 'Orange (Citrus sinensis)',
    'Baobab (Adansonia digitata)': 'Baobab pulp (Adansonia digitata)',
    'Fluted Pumpkin (Telfairia occidentalis)': 'Fluted pumpkin (Telfairia occidentalis)',
    'Spinach (Amaranthus hybridus)': 'Spinach (Amaranthus hybridus)'
})

# Merge the result with initial properties (on Crop)
final_merged_data = final_data.merge(initial_features, on='Crop', how='left')

# Reorder columns for logical flow in a training set
cols = ['Crop', 'Temp (°C)', 'Time (min)'] + \
       [col for col in final_merged_data.columns if col not in ['Crop', 'Temp (°C)', 'Time (min)']]

final_merged_data = final_merged_data[cols]

# Save the final DataFrame to CSV
final_merged_data.to_csv('core_training_data_merged.csv', index=False)

print("The 120 rows of core training data have been successfully merged and saved to 'core_training_data_merged.csv'.")
print("Data head (first 5 rows) and structure:")
print(f"Final Merged Data Head:\n{final_merged_data.head().to_markdown(index=False)}")
print(f"Final Merged Data Info:")
final_merged_data.info()
